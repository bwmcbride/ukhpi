#!/bin/bash
# Run a query against the UKHPI endpoint to query all region data to query-results.json
# Assumes Fuseki root is $FUSEKI, default ~/dev/java/jena-fuseki

rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
qb="http://purl.org/linked-data/cube"
hpi="http://landregistry.data.gov.uk/def/ukhpi"
rdfs="http://www.w3.org/2000/01/rdf-schema"
sr="http://data.ordnancesurvey.co.uk/ontology/spatialrelations"
owl="http://www.w3.org/2002/07/owl"

query="select distinct ?refRegion ?label ?type ?parent ?same {
  ?obs a <$qb#Observation> ;
    <$hpi/refRegion> ?refRegion.
  ?refRegion <$rdfs#label> ?label.
  ?refRegion <${rdf}type> ?type.
  optional {?refRegion <$sr/within> ?parent.}
  optional {?refRegion <$owl#sameAs> ?same}
}"

squery=${FUSEKI:-~/dev/java/jena-fuseki}/bin/s-query
server=${SERVER:-http://lr-data-dev-c.epimorphics.net/landregistry/query}

$squery --server="$server" "$query" > query-results.json

